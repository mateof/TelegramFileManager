@using TelegramDownloader.Data
@using TelegramDownloader.Models
@using TelegramDownloader.Services
@using TelegramDownloader.Pages.Modals.InfoModals
@implements IDisposable

@inject TransactionInfoService tis

<Grid @ref="grid"
      TItem="InfoDownloadTaksModel"
      Class="table"
      DataProvider="TasksDataProvider"
      AllowFiltering="false"
      AllowPaging="true"
      AllowSorting="false"
      Responsive="true"
      ItemsPropertyName="_internalId">

    <GridColumn TItem="InfoDownloadTaksModel" HeaderText="Destination" PropertyName="toPath" HeaderTextAlignment="Alignment.Start" TextAlignment="Alignment.Start">
        <div class="task-destination">
            <div class="task-icon">
                <i class="bi bi-folder2-open"></i>
            </div>
            <div class="task-info">
                <div class="task-path" title="@context.toPath">@GetShortPath(context.toPath)</div>
                <div class="task-count">
                    <i class="bi bi-files"></i>
                    @context.executed / @context.total files
                </div>
            </div>
        </div>
    </GridColumn>

    <GridColumn TItem="InfoDownloadTaksModel" HeaderText="Progress" PropertyName="progress">
        <div class="progress-container">
            <div class="progress-wrapper">
                <div class="progress-stats">
                    <span class="progress-percent @(context.progress >= 100 ? "complete" : "")">@context.progress%</span>
                    <span class="progress-files">@context.executed of @context.total</span>
                </div>
                <div class="progress">
                    <div class="progress-bar @GetProgressClass(context)"
                         role="progressbar"
                         style="width: @context.progress%;"
                         aria-valuenow="@context.progress"
                         aria-valuemin="0"
                         aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>
    </GridColumn>

    <GridColumn TItem="InfoDownloadTaksModel" HeaderText="Status">
        <span class="status-badge @GetStatusClass(context)">
            <i class="bi @GetStatusIcon(context)"></i>
            @GetStatusText(context)
        </span>
    </GridColumn>

    <GridColumn TItem="InfoDownloadTaksModel" HeaderText="Actions">
        <div class="action-buttons">
            @if (context.state == StateTask.Working)
            {
                <button class="action-btn cancel" @onclick="() => cancel(context)" title="Cancel">
                    <i class="bi bi-x-lg"></i>
                </button>
            }

            @if (context.state == StateTask.Canceled || context.state == StateTask.Error)
            {
                <button class="action-btn retry" @onclick="() => retry(context)" title="Retry">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <button class="action-btn delete" @onclick="() => delete(context)" title="Delete">
                    <i class="bi bi-trash3"></i>
                </button>
            }

            @if (context.state == StateTask.Completed)
            {
                <button class="action-btn delete" @onclick="() => delete(context)" title="Delete">
                    <i class="bi bi-trash3"></i>
                </button>
            }

            <button class="action-btn info" @onclick="() => infoModal.ShowModal(context)" title="Info">
                <i class="bi bi-info-lg"></i>
            </button>
        </div>
    </GridColumn>

</Grid>

<TelegramDownloader.Pages.Modals.InfoModals.TaskInfoModal @ref="infoModal"></TelegramDownloader.Pages.Modals.InfoModals.TaskInfoModal>

@code {

    BlazorBootstrap.Grid<InfoDownloadTaksModel> grid = default!;
    public static List<InfoDownloadTaksModel> lpt = new List<InfoDownloadTaksModel>();
    TaskInfoModal infoModal { get; set; }
    private bool _disposed = false;

    private string GetShortPath(string path)
    {
        if (string.IsNullOrEmpty(path)) return "Unknown";

        var parts = path.Split(new[] { '/', '\\' }, StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length <= 2) return path;

        return ".../" + string.Join("/", parts.TakeLast(2));
    }

    private string GetProgressClass(InfoDownloadTaksModel task)
    {
        if (task.state == StateTask.Completed || task.progress >= 100) return "complete";
        if (task.state == StateTask.Error || task.state == StateTask.Canceled) return "error";
        return "";
    }

    private string GetStatusClass(InfoDownloadTaksModel task)
    {
        return task.state switch
        {
            StateTask.Working => "working",
            StateTask.Completed => "completed",
            StateTask.Error => "error",
            StateTask.Canceled => "canceled",
            StateTask.Pending => "pending",
            _ => "pending"
        };
    }

    private string GetStatusIcon(InfoDownloadTaksModel task)
    {
        return task.state switch
        {
            StateTask.Working => "bi-arrow-repeat",
            StateTask.Completed => "bi-check-circle",
            StateTask.Error => "bi-exclamation-circle",
            StateTask.Canceled => "bi-slash-circle",
            StateTask.Pending => "bi-clock",
            _ => "bi-clock"
        };
    }

    private string GetStatusText(InfoDownloadTaksModel task)
    {
        return task.state switch
        {
            StateTask.Working => "Working",
            StateTask.Completed => "Completed",
            StateTask.Error => "Error",
            StateTask.Canceled => "Canceled",
            StateTask.Pending => "Pending",
            _ => "Pending"
        };
    }

    protected override async Task OnInitializedAsync()
    {
        checkNewEventsHandler();
        tis.EventChanged += eventChangedNew;
    }

    private async Task<GridDataProviderResult<InfoDownloadTaksModel>> TasksDataProvider(GridDataProviderRequest<InfoDownloadTaksModel> request)
    {
        await getPendingTasksModels(request.PageNumber - 1, request.PageSize, lpt.Count() == 0);
        int totalUploads = tis.getTotalTasks();
        return await Task.FromResult(new GridDataProviderResult<InfoDownloadTaksModel> { Data = lpt ?? new List<InfoDownloadTaksModel>(), TotalCount = totalUploads });//request.ApplyTo(uploads));
    }

    private async Task getPendingTasksModels(int pageNumber, int pageSize, bool mustCallEnventHandler = false)
    {
        lpt = tis.getInfoDownloadTaksModel(pageNumber, pageSize);
        if (mustCallEnventHandler)
            checkNewEventsHandler();
    }

    private void checkNewEventsHandler()
    {
        foreach (InfoDownloadTaksModel pt in lpt)
        {
            pt.EventChanged -= eventChangedPendingTask;
            pt.EventChanged += eventChangedPendingTask;
        }
    }

    void eventChangedPendingTask(object sender, InfoTaskEventArgs e)
    {
        if (_disposed) return;
        grid.RefreshDataAsync();
    }

    void eventChangedNew(object sender, System.EventArgs e)
    {
        if (_disposed) return;
        checkNewEventsHandler();
        grid.RefreshDataAsync();
    }

    private async Task cancel(InfoDownloadTaksModel idt)
    {
        idt.cancelTask();
        if (!_disposed)
            await InvokeAsync(StateHasChanged);
    }

    private async Task delete(InfoDownloadTaksModel idt)
    {
        tis.deleteInfoDownloadTaskFromList(idt);
    }

    private async Task retry(InfoDownloadTaksModel idt)
    {
        idt.Retry();
        if (!_disposed)
            await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        _disposed = true;
        tis.EventChanged -= eventChangedNew;
        foreach (InfoDownloadTaksModel pt in lpt)
        {
            pt.EventChanged -= eventChangedPendingTask;
        }
    }
}
