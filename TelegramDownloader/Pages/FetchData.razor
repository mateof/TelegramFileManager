@page "/fetchdata/{id}"
@using System.Text.RegularExpressions
@using TelegramDownloader.Data
@using TL
@using TelegramDownloader.Models
@using TelegramDownloader.Services

@inject ITelegramService ts;
@inject NavigationManager NavManager;
@inject PreloadService PreloadService;

<PageTitle>Chat Messages</PageTitle>

@if (m == null)
{
    <div class="chat-page">
        <div class="empty-state">
            <i class="bi bi-chat-dots"></i>
            <h3>Select a channel</h3>
            <p>Choose a channel from the sidebar to view messages</p>
        </div>
    </div>
}
else
{
    <div class="chat-page">
        <!-- Header -->
        <div class="chat-header">
            <div class="chat-header-left">
                <h2><i class="bi bi-chat-text"></i> Messages</h2>
                @if(m.Count > 0)
                {
                    <span class="message-count">@m.Count loaded</span>
                }
            </div>
            <div class="toggle-container">
                <Switch @bind-Value="showAll" @ref="allMessageSwitch" @oninput="ShowAllChanged" Label="Load all messages" />
            </div>
        </div>

        <!-- Messages List -->
        @if(m.Count > 0)
        {
            <div class="messages-list">
                @foreach (var mess in m)
                {
                    <TelegramDownloader.Pages.Partials.ChatMessage mess="@mess" modal="Modal" />
                }
            </div>

            @if (!showAll)
            {
                <div class="load-more-container">
                    <button type="button" class="btn-load-more" @onclick="moreElements">
                        <i class="bi bi-arrow-down-circle"></i>
                        Load more messages
                    </button>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <h3>No messages</h3>
                <p>This channel doesn't have any messages yet</p>
            </div>
        }
    </div>

    <TelegramDownloader.Pages.Modals.DownloadModal @ref="Modal"></TelegramDownloader.Pages.Modals.DownloadModal>
}

@* <script>
    var toastElList = [].slice.call(document.querySelectorAll('.toast'))
    var toastList = toastElList.map(function (toastEl) {
        return new bootstrap.Toast(toastEl, option)
    })
    for (const t of toastList) {
        t.show();
    }
</script> *@

@code {
#pragma warning disable BL0007 // Component parameter with custom setter for change detection
    private Modals.DownloadModal Modal { get; set; }
    private string? idChat;
    private int elements = 20;
    private int page = 0;
    bool showAll = false;
    Switch allMessageSwitch { get; set; }
    [Parameter]
    public string? id {
        get => idChat;
        set
        {
            if (idChat != value)
            {
                idChat = value;
                updateId();
            }
        }
    }


    private async Task<string> downloadPhoto(ChatMessages m)
    {
        return await ts.DownloadFile(m, idChat);
    }

    public List<ChatMessages> m = null;


    private async Task ShowAllChanged(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        if (args.Value != null)
            if ((bool) args.Value)
            {
                if (!String.IsNullOrEmpty(idChat))
                {
                    PreloadService.Show(SpinnerColor.Light, "Loading data...");
                    m = await ts.getAllMessages(long.Parse(idChat));
                    downloadPhotos(m);
                    PreloadService.Hide();
                    StateHasChanged();
                }
            } else 
            {
                await updateId(isRefresh: true);
            }
    }

    protected override async Task OnInitializedAsync()
    {
        if (!ts.checkUserLogin()) NavManager.NavigateTo("/");
    }

    private async Task downloadPhotos(List<ChatMessages> m)
    {
        foreach (ChatMessages mess in m)
        {
            if (mess.message.media is MessageMediaPhoto { photo: Photo photo })
            {
                await downloadPhoto(mess);
            }
        }
    }

    private async Task updateId(bool isRefresh = false)
    {
        if (!isRefresh)
            showAll = false;
        page = 0;
        if (!String.IsNullOrEmpty(idChat))
        {
            m = new List<ChatMessages>();
            await moreElements();
        }
    }

    private async Task moreElements()
    {
        PreloadService.Show(SpinnerColor.Light, "Loading data...");
        if (!String.IsNullOrEmpty(idChat))
        {
            List<ChatMessages> mb = await ts.getChatHistory(long.Parse(idChat), limit: elements, addOffset: elements * page);
            m.AddRange(mb);
            downloadPhotos(page > 0 ? mb : m);
            page += 1;
            StateHasChanged();
        }
        PreloadService.Hide();
    }

    public async Task save(ChatMessages cm)
    {
        await ts.DownloadFile(cm);
    }
}
