@page "/downloads"

@using TelegramDownloader.Data
@using TelegramDownloader.Data.db
@using TelegramDownloader.Models
@using TelegramDownloader.Services
@using Microsoft.AspNetCore.WebUtilities

@inject TransactionInfoService tis
@inject NavigationManager NavigationManager
@inject ITaskPersistenceService taskPersistence
@inject IDbService dbService

<div class="downloads-header">
    <h2 class="downloads-title">
        <i class="bi bi-cloud-arrow-down-fill"></i>
        Tasks Manager
    </h2>
    <div class="stats-summary">
        <div class="stat-card">
            <div class="stat-icon pending">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="stat-info">
                <h4>@tis.getTotalTasks()</h4>
                <p>Batch Tasks</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon downloads">
                <i class="bi bi-download"></i>
            </div>
            <div class="stat-info">
                <h4>@tis.getTotalDownloads(false)</h4>
                <p>Downloads</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon uploads">
                <i class="bi bi-upload"></i>
            </div>
            <div class="stat-info">
                <h4>@tis.getTotalUploads()</h4>
                <p>Uploads</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon persisted">
                <i class="bi bi-database"></i>
            </div>
            <div class="stat-info">
                <h4>@persistedTasksCount</h4>
                <p>Saved Tasks</p>
            </div>
        </div>
    </div>
</div>

<Tabs @ref="tabsRef" EnableFadeEffect="true">
    <Tab Title="Pending Tasks" Name="tasks" IsActive="true">
        <Content>
            <div class="tab-actions">
                <span class="tab-actions-title">Actions</span>
                <div class="action-btn-group">
                    <button class="action-btn clear" @onclick="clearTasks" title="Clear completed and error">
                        <i class="bi bi-trash3"></i>
                        <span>Clear</span>
                    </button>
                </div>
            </div>

            <TelegramDownloader.Pages.Partials.TasksTable></TelegramDownloader.Pages.Partials.TasksTable>
        </Content>
    </Tab>
    <Tab Title="Downloads" Name="downloads">
        <Content>
            <div class="tab-actions">
                <span class="tab-actions-title">Actions</span>
                <div class="action-btn-group">
                    <button class="action-btn clear" @onclick="clearDownloads" title="Clear completed and error">
                        <i class="bi bi-trash3"></i>
                        <span>Clear</span>
                    </button>
                    @if (tis.isPauseDownloads)
                    {
                        <button class="action-btn play" @onclick="() => tis.PlayDownloads()" title="Resume downloads">
                            <i class="bi bi-play-fill"></i>
                            <span>Play</span>
                        </button>
                    }
                    else
                    {
                        <button class="action-btn pause" @onclick="() => tis.PauseDownloads()" title="Pause downloads">
                            <i class="bi bi-pause-fill"></i>
                            <span>Pause</span>
                        </button>
                    }
                    <button class="action-btn stop" @onclick="() => tis.StopDownloads()" title="Stop all downloads">
                        <i class="bi bi-stop-fill"></i>
                        <span>Stop</span>
                    </button>
                </div>
            </div>
            <Tabs EnableFadeEffect="true">
                <Tab Title="Active" IsActive="true">
                    <Content>
                        <TelegramDownloader.Pages.Partials.DownloadsTable isPending="false"></TelegramDownloader.Pages.Partials.DownloadsTable>
                    </Content>
                </Tab>
                <Tab Title="Queue">
                    <Content>
                        <TelegramDownloader.Pages.Partials.DownloadsTable isPending="true"></TelegramDownloader.Pages.Partials.DownloadsTable>
                    </Content>
                </Tab>
            </Tabs>
        </Content>
    </Tab>
    <Tab Title="Uploads" Name="uploads">
        <Content>
            <div class="tab-actions">
                <span class="tab-actions-title">Actions</span>
                <div class="action-btn-group">
                    <button class="action-btn clear" @onclick="clearUploads" title="Clear completed and error">
                        <i class="bi bi-trash3"></i>
                        <span>Clear</span>
                    </button>
                </div>
            </div>
            <Tabs EnableFadeEffect="true">
                <Tab Title="Active" IsActive="true">
                    <Content>
                        <TelegramDownloader.Pages.Partials.UploadsTable isPending="false"></TelegramDownloader.Pages.Partials.UploadsTable>
                    </Content>
                </Tab>
                <Tab Title="Queue">
                    <Content>
                        <TelegramDownloader.Pages.Partials.UploadsTable isPending="true"></TelegramDownloader.Pages.Partials.UploadsTable>
                    </Content>
                </Tab>
            </Tabs>
        </Content>
    </Tab>
    <Tab Title="Saved Tasks" Name="persisted">
        <Content>
            <div class="tab-actions">
                <span class="tab-actions-title">Persisted Tasks</span>
                <div class="action-btn-group">
                    <button class="action-btn clear" @onclick="ClearAllPersistedTasks" title="Clear all persisted tasks">
                        <i class="bi bi-trash3"></i>
                        <span>Clear All</span>
                    </button>
                </div>
            </div>
            <TelegramDownloader.Pages.Partials.PersistedTasksTable @ref="persistedTasksTable"></TelegramDownloader.Pages.Partials.PersistedTasksTable>
        </Content>
    </Tab>
</Tabs>

<ConfirmDialog @ref="confirmDialog" />

@code {
    private Tabs tabsRef = default!;
    private string activeTab = "tasks";
    private bool tabInitialized = false;
    private int persistedTasksCount = 0;
    private TelegramDownloader.Pages.Partials.PersistedTasksTable persistedTasksTable;
    private ConfirmDialog confirmDialog = default!;

    protected override void OnInitialized()
    {
        // Parse the query string to get the tab parameter
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("tab", out var tabValue))
        {
            var tab = tabValue.ToString().ToLower();
            if (tab == "uploads" || tab == "downloads" || tab == "tasks" || tab == "persisted")
            {
                activeTab = tab;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadPersistedTasksCount();
    }

    private async Task LoadPersistedTasksCount()
    {
        try
        {
            var tasks = await taskPersistence.LoadPendingTasks();
            persistedTasksCount = tasks?.Count ?? 0;
        }
        catch
        {
            persistedTasksCount = 0;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !tabInitialized && activeTab != "tasks")
        {
            tabInitialized = true;
            try
            {
                await tabsRef.ShowTabByNameAsync(activeTab);
            }
            catch
            {
                // Ignore if tab not found
            }
        }
    }

    async Task clearUploads()
    {
        tis.clearUploadCompleted();
    }

    async Task clearDownloads()
    {
        tis.clearDownloadCompleted();
    }

    async Task clearTasks()
    {
        tis.clearTasksCompleted();
    }

    async Task ClearAllPersistedTasks()
    {
        var confirmed = await confirmDialog.ShowAsync(
            title: "Clear All Saved Tasks",
            message1: "Are you sure you want to delete all saved tasks from the database?",
            message2: "This action cannot be undone.");

        if (confirmed)
        {
            try
            {
                await dbService.ClearAllTasks();
                persistedTasksCount = 0;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                // Log error
            }
        }
    }
}
