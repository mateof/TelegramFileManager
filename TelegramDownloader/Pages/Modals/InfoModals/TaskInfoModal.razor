@using TelegramDownloader.Models
@using TelegramDownloader.Services

<style>
    .task-info-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 1050;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .task-info-modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .task-info-modal-container {
        width: 100%;
        max-width: 500px;
        margin: 1rem;
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        transform: scale(0.9) translateY(20px);
        transition: transform 0.3s ease;
    }

    .task-info-modal-overlay.show .task-info-modal-container {
        transform: scale(1) translateY(0);
    }

    .task-info-modal-header {
        background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
        padding: 1rem 1.25rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .task-info-modal-title {
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }

    .task-info-modal-title i {
        color: #a855f7;
    }

    .task-info-modal-close {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .task-info-modal-close:hover {
        background: rgba(168, 85, 247, 0.3);
        color: #fff;
        transform: rotate(90deg);
    }

    .task-info-modal-body {
        padding: 1.25rem;
    }

    /* Progress Section */
    .task-info-progress-section {
        background: rgba(0,0,0,0.2);
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .task-info-progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .task-info-progress-percent {
        font-size: 1.5rem;
        font-weight: 700;
        color: #a855f7;
    }

    .task-info-progress-bar {
        height: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .task-info-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #a855f7 0%, #d946ef 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .task-info-progress-fill.completed {
        background: linear-gradient(90deg, #28a745 0%, #5dd879 100%);
    }

    .task-info-progress-fill.error {
        background: linear-gradient(90deg, #dc3545 0%, #ff6b6b 100%);
    }

    .task-info-progress-details {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.6);
    }

    /* Task Info */
    .task-info-type-info {
        background: rgba(168, 85, 247, 0.1);
        border: 1px solid rgba(168, 85, 247, 0.2);
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .task-info-type-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .task-info-type-icon i {
        font-size: 1.5rem;
        color: white;
    }

    .task-info-type-details {
        flex: 1;
        min-width: 0;
    }

    .task-info-type-name {
        color: white;
        font-weight: 500;
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
    }

    .task-info-type-paths {
        color: rgba(255,255,255,0.5);
        font-size: 0.75rem;
    }

    .task-info-type-paths div {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Info Grid */
    .task-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .task-info-item {
        background: rgba(255,255,255,0.05);
        border-radius: 0.5rem;
        padding: 0.75rem;
    }

    .task-info-item.full-width {
        grid-column: span 2;
    }

    .task-info-label {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        color: rgba(255,255,255,0.5);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .task-info-label i {
        font-size: 0.875rem;
        color: #a855f7;
    }

    .task-info-value {
        color: white;
        font-weight: 500;
        font-size: 0.9rem;
    }

    /* State Badge */
    .task-state-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .task-state-badge.completed {
        background: rgba(40, 167, 69, 0.2);
        color: #5dd879;
    }

    .task-state-badge.working {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
    }

    .task-state-badge.error {
        background: rgba(220, 53, 69, 0.2);
        color: #ff6b6b;
    }

    .task-state-badge.canceled {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }

    .task-state-badge.pending {
        background: rgba(108, 117, 125, 0.2);
        color: #adb5bd;
    }

    .task-state-badge.paused {
        background: rgba(23, 162, 184, 0.2);
        color: #17a2b8;
    }

    .task-state-badge i {
        font-size: 0.75rem;
    }

    /* Type Badge */
    .task-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .task-type-badge.upload {
        background: rgba(233, 69, 96, 0.2);
        color: #e94560;
    }

    .task-type-badge.download {
        background: rgba(79, 172, 254, 0.2);
        color: #4facfe;
    }

    .task-type-badge i {
        font-size: 0.75rem;
    }

    /* Responsive */
    @@media (max-width: 576px) {
        .task-info-modal-overlay {
            align-items: stretch;
        }

        .task-info-modal-container {
            max-width: 100%;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 0;
            display: flex;
            flex-direction: column;
        }

        .task-info-modal-body {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 2rem;
        }

        .task-info-grid {
            grid-template-columns: 1fr;
        }

        .task-info-item.full-width {
            grid-column: span 1;
        }
    }
</style>

<div class="task-info-modal-overlay @(isVisible ? "show" : "")" @onclick="OnOverlayClick">
    <div class="task-info-modal-container" @onclick:stopPropagation="true">
        <div class="task-info-modal-header">
            <h5 class="task-info-modal-title">
                <i class="bi bi-list-task"></i>
                Task Details
            </h5>
            <button class="task-info-modal-close" @onclick="HideModal">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        @if (taskModel != null)
        {
            <div class="task-info-modal-body">
                <!-- Progress Section -->
                <div class="task-info-progress-section">
                    <div class="task-info-progress-header">
                        <div class="task-info-progress-status">
                            <span class="task-state-badge @GetStateClass(taskModel.state)">
                                <i class="bi @GetStateIcon(taskModel.state)"></i>
                                @taskModel.state
                            </span>
                        </div>
                        <span class="task-info-progress-percent">@GetProgressPercent()%</span>
                    </div>
                    <div class="task-info-progress-bar">
                        <div class="task-info-progress-fill @GetProgressClass(taskModel.state)"
                             style="width: @GetProgressPercent()%"></div>
                    </div>
                    <div class="task-info-progress-details">
                        <span>@taskModel.executed / @taskModel.total files</span>
                        <span>@GetAverageSpeed()</span>
                    </div>
                </div>

                <!-- Task Type Info -->
                <div class="task-info-type-info">
                    <div class="task-info-type-icon">
                        <i class="bi @(taskModel.isUpload ? "bi-cloud-arrow-up" : "bi-cloud-arrow-down")"></i>
                    </div>
                    <div class="task-info-type-details">
                        <div class="task-info-type-name">
                            <span class="task-type-badge @(taskModel.isUpload ? "upload" : "download")">
                                <i class="bi @(taskModel.isUpload ? "bi-arrow-up" : "bi-arrow-down")"></i>
                                @(taskModel.isUpload ? "Upload Task" : "Download Task")
                            </span>
                        </div>
                        <div class="task-info-type-paths">
                            <div title="@taskModel.fromPath"><i class="bi bi-folder"></i> @taskModel.fromPath</div>
                            <div title="@taskModel.toPath"><i class="bi bi-folder-symlink"></i> @taskModel.toPath</div>
                        </div>
                    </div>
                </div>

                <!-- Info Grid -->
                <div class="task-info-grid">
                    <div class="task-info-item">
                        <div class="task-info-label">
                            <i class="bi bi-files"></i>
                            Total Files
                        </div>
                        <div class="task-info-value">@taskModel.total</div>
                    </div>

                    <div class="task-info-item">
                        <div class="task-info-label">
                            <i class="bi bi-check2-circle"></i>
                            Completed
                        </div>
                        <div class="task-info-value">@taskModel.executed</div>
                    </div>

                    <div class="task-info-item">
                        <div class="task-info-label">
                            <i class="bi bi-hdd"></i>
                            Total Size
                        </div>
                        <div class="task-info-value">@HelperService.SizeSuffix(taskModel.totalSize)</div>
                    </div>

                    <div class="task-info-item">
                        <div class="task-info-label">
                            <i class="bi bi-cloud-arrow-up"></i>
                            Transferred
                        </div>
                        <div class="task-info-value">@HelperService.SizeSuffix(taskModel.executedSize)</div>
                    </div>

                    <div class="task-info-item">
                        <div class="task-info-label">
                            <i class="bi bi-calendar-plus"></i>
                            Created
                        </div>
                        <div class="task-info-value">@taskModel.creationDate.ToString("dd/MM/yy HH:mm")</div>
                    </div>

                    <div class="task-info-item">
                        <div class="task-info-label">
                            <i class="bi bi-stopwatch"></i>
                            Duration
                        </div>
                        <div class="task-info-value">@GetDuration()</div>
                    </div>

                    @if (taskModel.state == StateTask.Completed && taskModel.endnDate != default)
                    {
                        <div class="task-info-item full-width">
                            <div class="task-info-label">
                                <i class="bi bi-check-circle"></i>
                                Completed At
                            </div>
                            <div class="task-info-value">@taskModel.endnDate.ToString("dd/MM/yy HH:mm:ss")</div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public InfoDownloadTaksModel taskModel { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private bool isVisible = false;

    public async Task ShowModal(InfoDownloadTaksModel taskModel)
    {
        this.taskModel = taskModel;
        if (this.taskModel != null)
        {
            isVisible = true;
            StateHasChanged();
        }
    }

    private async Task HideModal()
    {
        isVisible = false;
        StateHasChanged();

        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
    }

    private async Task OnOverlayClick()
    {
        await HideModal();
    }

    private int GetProgressPercent()
    {
        if (taskModel.total == 0) return 0;
        return (int)((double)taskModel.executed / taskModel.total * 100);
    }

    private string GetDuration()
    {
        DateTime endTime = taskModel.state == StateTask.Completed && taskModel.endnDate != default
            ? taskModel.endnDate
            : DateTime.Now;

        TimeSpan duration = endTime - taskModel.creationDate;

        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h {duration.Minutes}m {duration.Seconds}s";
        if (duration.TotalMinutes >= 1)
            return $"{duration.Minutes}m {duration.Seconds}s";
        return $"{duration.Seconds}s";
    }

    private string GetAverageSpeed()
    {
        if (taskModel.executedSize == 0)
            return "-";

        DateTime endTime = taskModel.state == StateTask.Completed && taskModel.endnDate != default
            ? taskModel.endnDate
            : DateTime.Now;

        double seconds = (endTime - taskModel.creationDate).TotalSeconds;
        if (seconds <= 0)
            return "-";

        double bytesPerSecond = taskModel.executedSize / seconds;
        return $"{HelperService.SizeSuffix((long)bytesPerSecond)}/s";
    }

    private string GetStateClass(StateTask state)
    {
        return state switch
        {
            StateTask.Completed => "completed",
            StateTask.Working => "working",
            StateTask.Error => "error",
            StateTask.Canceled => "canceled",
            StateTask.Pending => "pending",
            StateTask.Paused => "paused",
            _ => "pending"
        };
    }

    private string GetStateIcon(StateTask state)
    {
        return state switch
        {
            StateTask.Completed => "bi-check-circle-fill",
            StateTask.Working => "bi-arrow-repeat",
            StateTask.Error => "bi-x-circle-fill",
            StateTask.Canceled => "bi-slash-circle",
            StateTask.Pending => "bi-clock",
            StateTask.Paused => "bi-pause-circle",
            _ => "bi-circle"
        };
    }

    private string GetProgressClass(StateTask state)
    {
        return state switch
        {
            StateTask.Completed => "completed",
            StateTask.Error => "error",
            _ => ""
        };
    }
}
