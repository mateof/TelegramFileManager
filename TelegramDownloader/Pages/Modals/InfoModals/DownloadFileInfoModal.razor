@using TelegramDownloader.Models
@using TelegramDownloader.Services

<Modal @ref="Modal" title="Download Info" Size="ModalSize.ExtraLarge">
    <BodyTemplate>
        @if (downloadModel != null)
        {
            <table class="table table-striped">
                <tbody>
                    <tr>
                        <th scope="row"><i class="bi bi-file-earmark"></i> File Name</th>
                        <td>@downloadModel.name</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="bi bi-folder"></i> Path</th>
                        <td>@downloadModel.path</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="bi bi-chat"></i> Channel</th>
                        <td>@downloadModel.channelName</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="bi bi-hdd"></i> Size</th>
                        <td>@downloadModel._sizeString</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="bi bi-cloud-download"></i> Transmitted</th>
                        <td>@downloadModel._transmittedString</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="bi bi-flag"></i> State</th>
                        <td>
                            <span class="badge @GetStateBadgeClass(downloadModel.state)">@downloadModel.state</span>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="bi bi-calendar-plus"></i> Creation Date</th>
                        <td>@downloadModel.creationDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="bi bi-play-circle"></i> Start Date</th>
                        <td>@(downloadModel.startDate != default ? downloadModel.startDate.ToString("yyyy-MM-dd HH:mm:ss") : "-")</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="bi bi-stop-circle"></i> End Date</th>
                        <td>@(downloadModel.endnDate != default && downloadModel.state == StateTask.Completed ? downloadModel.endnDate.ToString("yyyy-MM-dd HH:mm:ss") : "-")</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="bi bi-stopwatch"></i> Duration</th>
                        <td>@GetDuration()</td>
                    </tr>
                    <tr>
                        <th scope="row"><i class="bi bi-speedometer2"></i> Average Speed</th>
                        <td>@GetAverageSpeed()</td>
                    </tr>
                </tbody>
            </table>
        }
    </BodyTemplate>
</Modal>

@code {
    [Parameter]
    public DownloadModel downloadModel { get; set; }
    private Modal Modal = default!;

    public async Task ShowModal(DownloadModel downloadModel)
    {
        this.downloadModel = downloadModel;
        if (this.downloadModel != null)
        {
            await Modal.ShowAsync();
        }
    }

    private string GetDuration()
    {
        if (downloadModel.startDate == default)
            return "-";

        DateTime endTime = downloadModel.state == StateTask.Completed && downloadModel.endnDate != default
            ? downloadModel.endnDate
            : DateTime.Now;

        TimeSpan duration = endTime - downloadModel.startDate;

        if (duration.TotalHours >= 1)
            return $"{(int)duration.TotalHours}h {duration.Minutes}m {duration.Seconds}s";
        if (duration.TotalMinutes >= 1)
            return $"{duration.Minutes}m {duration.Seconds}s";
        return $"{duration.Seconds}s";
    }

    private string GetAverageSpeed()
    {
        if (downloadModel.startDate == default || downloadModel._transmitted == 0)
            return "-";

        DateTime endTime = downloadModel.state == StateTask.Completed && downloadModel.endnDate != default
            ? downloadModel.endnDate
            : DateTime.Now;

        double seconds = (endTime - downloadModel.startDate).TotalSeconds;
        if (seconds <= 0)
            return "-";

        double bytesPerSecond = downloadModel._transmitted / seconds;
        return $"{HelperService.SizeSuffix((long)bytesPerSecond)}/s";
    }

    private string GetStateBadgeClass(StateTask state)
    {
        return state switch
        {
            StateTask.Completed => "bg-success",
            StateTask.Working => "bg-primary",
            StateTask.Error => "bg-danger",
            StateTask.Canceled => "bg-warning",
            StateTask.Pending => "bg-secondary",
            StateTask.Paused => "bg-info",
            _ => "bg-secondary"
        };
    }
}
