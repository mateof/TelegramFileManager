@using TelegramDownloader.Data
@using TelegramDownloader.Models
@inject ILogger<FileManager> Logger;
@inject IFileService fs;
@inject ToastService toastService;

@if (showModal)
{
    <div class="import-modal-overlay @(showModal ? "show" : "")" @onclick="Close">
        <div class="import-modal-container" @onclick:stopPropagation="true">
            <div class="import-modal-header">
                <div class="import-modal-title">
                    <i class="bi bi-cloud-upload"></i>
                    <span>Import Channel Data</span>
                </div>
                <button type="button" class="import-modal-close" @onclick="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="import-modal-body">
                @if (!isLoading && loadedFiles.Count == 0 && npe == null)
                {
                    <label class="import-drop-zone">
                        <InputFile @key=@(_inputFileId) OnChange="LoadFiles" class="import-file-input" />
                        <div class="import-drop-icon">
                            <i class="bi bi-file-earmark-arrow-up"></i>
                        </div>
                        <div class="import-drop-text">
                            @if (isShared)
                            {
                                <span>Drop your shared data file here</span>
                            }
                            else
                            {
                                <span>Drop your channel export file here</span>
                            }
                        </div>
                        <div class="import-drop-hint">or click to browse</div>
                        <div class="import-drop-formats">
                            <span class="format-badge">.json</span>
                            <span class="format-badge">.zip</span>
                        </div>
                    </label>
                }

                @if (isLoading)
                {
                    <div class="import-loading">
                        <div class="import-loading-icon">
                            <i class="bi bi-cloud-arrow-up"></i>
                        </div>
                        <div class="import-loading-text">Uploading file...</div>
                        <div class="import-progress-container">
                            <div class="import-progress">
                                <div class="import-progress-bar" style="width: @(progressPercent * 100)%;"></div>
                            </div>
                            <span class="import-progress-text">@string.Format("{0:P0}", progressPercent)</span>
                        </div>
                    </div>
                }

                @if (!isLoading && loadedFiles.Count > 0)
                {
                    <div class="import-file-list">
                        @foreach (var file in loadedFiles)
                        {
                            <div class="import-file-item">
                                <div class="import-file-icon">
                                    <i class="bi @GetFileIcon(file.Name)"></i>
                                </div>
                                <div class="import-file-info">
                                    <div class="import-file-name">@file.Name</div>
                                    <div class="import-file-meta">
                                        <span><i class="bi bi-calendar3"></i> @file.LastModified.ToString("dd/MM/yyyy HH:mm")</span>
                                        <span><i class="bi bi-hdd"></i> @FormatFileSize(file.Size)</span>
                                    </div>
                                </div>
                                <div class="import-file-status">
                                    <i class="bi bi-check-circle-fill"></i>
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (npe != null)
                {
                    <div class="import-processing">
                        <div class="import-processing-header">
                            <i class="bi bi-gear-fill spinning"></i>
                            <span>Processing data...</span>
                        </div>
                        <div class="import-processing-stats">
                            <span class="import-stat-current">@npe.CompletedItems</span>
                            <span class="import-stat-separator">/</span>
                            <span class="import-stat-total">@npe.TotalItems</span>
                            <span class="import-stat-label">items</span>
                        </div>
                        <div class="import-progress-container">
                            <div class="import-progress processing">
                                <div class="import-progress-bar" style="width: @npe.Percent%;"></div>
                            </div>
                            <span class="import-progress-text">@npe.Percent%</span>
                        </div>
                        @if (npe.Percent >= 100)
                        {
                            <div class="import-complete-message">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>Import completed successfully!</span>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="import-modal-footer">
                @if (npe != null && npe.Percent >= 100)
                {
                    <button type="button" class="import-btn import-btn-success" @onclick="Close">
                        <i class="bi bi-check-lg"></i>
                        <span>Done</span>
                    </button>
                }
                else
                {
                    <button type="button" class="import-btn import-btn-secondary" @onclick="Close">
                        <i class="bi bi-x-lg"></i>
                        <span>Cancel</span>
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public EventCallback OnCloseCallback { get; set; }
    [Parameter]
    public string? id { get; set; }
    [Parameter]
    public bool isShared { get; set; } = false;
    private string _inputFileId = Guid.NewGuid().ToString();
    NotificationProgressEvent? npe { get; set; } = null;
    private bool showModal = false;
    private List<IBrowserFile> loadedFiles = new();
    private long maxFileSize = 1024 * 1024 * 500;
    private int maxAllowedFiles = 1;
    private bool isLoading;
    private decimal progressPercent;

    public async Task Open()
    {
        showModal = true;
        loadedFiles.Clear();
        _inputFileId = Guid.NewGuid().ToString();
        npe = null;
        progressPercent = 0;
        StateHasChanged();
    }

    public async Task Close()
    {
        showModal = false;
        if (OnCloseCallback.HasDelegate)
        {
            await OnCloseCallback.InvokeAsync(null);
        }
        StateHasChanged();
    }

    private string GetFileIcon(string fileName)
    {
        if (string.IsNullOrEmpty(fileName)) return "bi-file-earmark";
        var ext = Path.GetExtension(fileName)?.ToLower();
        return ext switch
        {
            ".json" => "bi-filetype-json",
            ".zip" => "bi-file-earmark-zip",
            ".xml" => "bi-filetype-xml",
            _ => "bi-file-earmark"
        };
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        int order = 0;
        double size = bytes;
        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size /= 1024;
        }
        return $"{size:0.##} {sizes[order]}";
    }

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        isLoading = true;
        loadedFiles.Clear();
        progressPercent = 0;


        foreach (var file in e.GetMultipleFiles(maxAllowedFiles))
        {
            if (!isShared)
                try
                {
                    var trustedFileName = file.Name;
                    // string fileName = $"importfile_{id}.json";
                    var path = System.IO.Path.Combine(FileService.TEMPDIR, trustedFileName);
                    if (File.Exists(path))
                        File.Delete(path);

                    await using FileStream writeStream = new(path, FileMode.Create);
                    using var readStream = file.OpenReadStream(maxFileSize);
                    var bytesRead = 0;
                    var totalRead = 0;
                    var buffer = new byte[1024 * 10];

                    while ((bytesRead = await readStream.ReadAsync(buffer)) != 0)
                    {
                        totalRead += bytesRead;
                        await writeStream.WriteAsync(buffer, 0, bytesRead);
                        progressPercent = Decimal.Divide(totalRead, file.Size);
                        StateHasChanged();
                    }

                    loadedFiles.Add(file);

                    Logger.LogInformation(
                        "Unsafe Filename: {UnsafeFilename} File saved: {Filename}",
                        file.Name, trustedFileName);

                    readStream.Dispose();
                    readStream.Close();
                    writeStream.Dispose();
                    writeStream.Close();
                    GenericNotificationProgressModel gnp = new GenericNotificationProgressModel();
                    gnp.EventNotification += eventChanged;
                    await fs.importData(id, path, gnp);
                }
                catch (Exception ex)
                {
                    Logger.LogError($"LoadFiles: {file.Name} Error: {ex.Message}",
                        file.Name, ex.Message);
                }
            else
            {
                try
                {
                    using(var ms = new MemoryStream())
                    {
                        await file.OpenReadStream(maxFileSize).CopyToAsync(ms);
                        ms.Position = 0;
                        ShareFilesModel? sfm = await FileService.UnZipArchiveToFile<ShareFilesModel>(ms);
                        GenericNotificationProgressModel gnp = new GenericNotificationProgressModel();
                        gnp.EventNotification += eventChanged;
                        await fs.importSharedData(sfm, gnp);
                    }
                    
                } catch(Exception ex)
                {
                    Logger.LogError($"LoadFiles shared: {file.Name} Error: {ex.Message}",
                        file.Name, ex.Message);
                }
                

            }
        }

        isLoading = false;
        await InvokeAsync(StateHasChanged);
    }

    async void eventChanged(object sender, NotificationProgressEvent e)
    {
        npe = e;
        await InvokeAsync(StateHasChanged);

    }


}
