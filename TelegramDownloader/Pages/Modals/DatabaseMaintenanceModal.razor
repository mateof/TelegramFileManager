@using TelegramDownloader.Data
@using TelegramDownloader.Data.db
@inject IDbService db
@inject ITelegramService ts
@inject ToastService toastService

@if (isVisible)
{
    <div class="maintenance-modal-overlay" @onclick="Close">
        <div class="maintenance-modal-container" @onclick:stopPropagation="true">
            <div class="maintenance-modal-header">
                <div class="maintenance-modal-title">
                    <i class="bi bi-database-gear"></i>
                    <span>Database Maintenance</span>
                </div>
                <button class="maintenance-modal-close" @onclick="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="maintenance-modal-body">
                @if (isLoading)
                {
                    <div class="maintenance-loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Scanning databases...</p>
                        @if (scanProgress > 0)
                        {
                            <div class="progress" style="width: 200px; height: 6px;">
                                <div class="progress-bar" role="progressbar" style="width: @scanProgress%"></div>
                            </div>
                            <small class="text-muted">@scanProgress% complete</small>
                        }
                    </div>
                }
                else if (orphanedDatabases == null || orphanedDatabases.Count == 0)
                {
                    <div class="maintenance-empty">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        <p>No orphaned databases found.</p>
                        <span class="text-muted">All databases are linked to active Telegram channels.</span>
                    </div>
                }
                else
                {
                    <div class="maintenance-info">
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span>Found <strong>@orphanedDatabases.Count</strong> database(s) without active Telegram channels. Total size: <strong>@FormatSize(totalSize)</strong></span>
                        </div>
                    </div>

                    <div class="maintenance-actions-top">
                        <button class="btn btn-outline-primary btn-sm" @onclick="SelectAll">
                            <i class="bi bi-check-all me-1"></i>
                            Select All
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" @onclick="DeselectAll">
                            <i class="bi bi-x-lg me-1"></i>
                            Deselect All
                        </button>
                        <span class="ms-auto text-muted">@selectedCount selected (@FormatSize(selectedSize))</span>
                    </div>

                    <div class="maintenance-list">
                        @foreach (var item in orphanedDatabases)
                        {
                            <div class="maintenance-item @(item.IsSelected ? "selected" : "")" @onclick="@(() => ToggleSelection(item))">
                                <div class="maintenance-item-check">
                                    <input type="checkbox" checked="@item.IsSelected" @onchange="@(() => ToggleSelection(item))" @onclick:stopPropagation="true" />
                                </div>
                                <div class="maintenance-item-info">
                                    <div class="maintenance-item-name">
                                        @if (!string.IsNullOrEmpty(item.ChannelName))
                                        {
                                            <i class="bi bi-chat-fill text-primary me-2"></i>
                                            <span>@item.ChannelName</span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-database text-secondary me-2"></i>
                                            <span class="text-muted">Unknown Channel</span>
                                        }
                                    </div>
                                    <div class="maintenance-item-id">
                                        <span class="badge bg-secondary">ID: @item.DatabaseName</span>
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle me-1"></i>Orphaned
                                        </span>
                                    </div>
                                    <div class="maintenance-item-stats">
                                        <div class="maintenance-stat">
                                            <i class="bi bi-hdd"></i>
                                            <span>@FormatSize(item.SizeInBytes)</span>
                                        </div>
                                        <div class="maintenance-stat">
                                            <i class="bi bi-files"></i>
                                            <span>@item.DocumentCount records</span>
                                        </div>
                                        @if (item.CreatedAt.HasValue)
                                        {
                                            <div class="maintenance-stat">
                                                <i class="bi bi-calendar-plus"></i>
                                                <span>Created: @item.CreatedAt.Value.ToString("dd/MM/yyyy")</span>
                                            </div>
                                        }
                                        @if (item.LastModified.HasValue)
                                        {
                                            <div class="maintenance-stat">
                                                <i class="bi bi-calendar-check"></i>
                                                <span>Modified: @item.LastModified.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="maintenance-item-action">
                                    <button class="btn btn-outline-danger btn-sm" @onclick="@(() => DeleteSingle(item))" @onclick:stopPropagation="true" disabled="@isDeleting">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            @if (orphanedDatabases != null && orphanedDatabases.Count > 0)
            {
                <div class="maintenance-modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="Close" disabled="@isDeleting">
                        Cancel
                    </button>
                    <button class="btn btn-danger" @onclick="DeleteSelected" disabled="@(selectedCount == 0 || isDeleting)">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Deleting...</span>
                        }
                        else
                        {
                            <i class="bi bi-trash me-2"></i>
                            <span>Delete Selected (@selectedCount)</span>
                        }
                    </button>
                </div>
            }
        </div>
    </div>
}

<style>
    .maintenance-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .maintenance-modal-container {
        position: relative;
        width: 100%;
        max-width: 650px;
        max-height: 85vh;
        background: var(--bs-body-bg);
        border-radius: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 100000;
    }

    .maintenance-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem;
        background: linear-gradient(135deg, var(--bs-primary) 0%, color-mix(in srgb, var(--bs-primary) 80%, black) 100%);
        color: white;
    }

    .maintenance-modal-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .maintenance-modal-title i {
        font-size: 1.5rem;
    }

    .maintenance-modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: background 0.2s;
    }

    .maintenance-modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .maintenance-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.25rem;
    }

    .maintenance-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        padding: 3rem;
        color: var(--bs-secondary-color);
    }

    .maintenance-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 3rem;
        text-align: center;
    }

    .maintenance-empty i {
        font-size: 3rem;
    }

    .maintenance-actions-top {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--bs-border-color);
    }

    .maintenance-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .maintenance-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 0.875rem 1rem;
        background: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .maintenance-item:hover {
        background: var(--bs-secondary-bg);
        border-color: var(--bs-primary);
    }

    .maintenance-item.selected {
        background: color-mix(in srgb, var(--bs-primary) 10%, var(--bs-body-bg));
        border-color: var(--bs-primary);
    }

    .maintenance-item-check {
        padding-top: 0.25rem;
    }

    .maintenance-item-check input[type="checkbox"] {
        width: 1.25rem;
        height: 1.25rem;
        cursor: pointer;
    }

    .maintenance-item-info {
        flex: 1;
        min-width: 0;
    }

    .maintenance-item-name {
        display: flex;
        align-items: center;
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .maintenance-item-name span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .maintenance-item-id {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-bottom: 0.5rem;
    }

    .maintenance-item-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        font-size: 0.8rem;
        color: var(--bs-secondary-color);
    }

    .maintenance-stat {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .maintenance-stat i {
        font-size: 0.85rem;
        opacity: 0.7;
    }

    .maintenance-item-action {
        flex-shrink: 0;
        padding-top: 0.25rem;
    }

    .maintenance-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        background: var(--bs-tertiary-bg);
        border-top: 1px solid var(--bs-border-color);
    }

    @@media (max-width: 576px) {
        .maintenance-modal-overlay {
            padding: 0;
        }

        .maintenance-modal-container {
            max-width: 100%;
            max-height: 100%;
            height: 100%;
            border-radius: 0;
        }

        .maintenance-actions-top {
            flex-wrap: wrap;
        }

        .maintenance-actions-top .ms-auto {
            width: 100%;
            text-align: center;
            margin-top: 0.5rem;
        }

        .maintenance-item-stats {
            flex-direction: column;
            gap: 0.35rem;
        }
    }
</style>

@code {
    private bool isVisible = false;
    private bool isLoading = false;
    private bool isDeleting = false;
    private int scanProgress = 0;
    private List<OrphanedDatabaseInfo>? orphanedDatabases;

    private int selectedCount => orphanedDatabases?.Count(x => x.IsSelected) ?? 0;
    private long selectedSize => orphanedDatabases?.Where(x => x.IsSelected).Sum(x => x.SizeInBytes) ?? 0;
    private long totalSize => orphanedDatabases?.Sum(x => x.SizeInBytes) ?? 0;

    public class OrphanedDatabaseInfo
    {
        public string DatabaseName { get; set; } = "";
        public string? ChannelName { get; set; }
        public bool HasTelegramAccess { get; set; }
        public bool IsSelected { get; set; }
        public long SizeInBytes { get; set; }
        public long DocumentCount { get; set; }
        public DateTime? CreatedAt { get; set; }
        public DateTime? LastModified { get; set; }
    }

    public async Task Open()
    {
        isVisible = true;
        isLoading = true;
        scanProgress = 0;
        orphanedDatabases = null;
        StateHasChanged();

        await ScanDatabases();

        isLoading = false;
        StateHasChanged();
    }

    public void Close()
    {
        if (isDeleting) return;
        isVisible = false;
        StateHasChanged();
    }

    private async Task ScanDatabases()
    {
        try
        {
            var allDatabases = await db.GetAllChannelDatabaseNames();
            orphanedDatabases = new List<OrphanedDatabaseInfo>();

            int processed = 0;
            int total = allDatabases.Count;

            foreach (var dbName in allDatabases)
            {
                if (long.TryParse(dbName, out var channelId))
                {
                    var (name, exists) = ts.GetChannelInfo(channelId);

                    // Only show databases where we don't have access to the channel
                    if (!exists)
                    {
                        var stats = await db.GetDatabaseStats(dbName);

                        orphanedDatabases.Add(new OrphanedDatabaseInfo
                        {
                            DatabaseName = dbName,
                            ChannelName = name,
                            HasTelegramAccess = exists,
                            IsSelected = false,
                            SizeInBytes = stats.SizeInBytes,
                            DocumentCount = stats.DocumentCount,
                            CreatedAt = stats.CreatedAt,
                            LastModified = stats.LastModified
                        });
                    }
                }

                processed++;
                scanProgress = (int)((double)processed / total * 100);
                StateHasChanged();
                await Task.Delay(1); // Allow UI to update
            }
        }
        catch (Exception ex)
        {
            toastService.Notify(new(ToastType.Danger, $"Error scanning databases: {ex.Message}") { Title = "Error", AutoHide = true });
        }
    }

    private void ToggleSelection(OrphanedDatabaseInfo item)
    {
        item.IsSelected = !item.IsSelected;
        StateHasChanged();
    }

    private void SelectAll()
    {
        if (orphanedDatabases != null)
        {
            foreach (var item in orphanedDatabases)
            {
                item.IsSelected = true;
            }
            StateHasChanged();
        }
    }

    private void DeselectAll()
    {
        if (orphanedDatabases != null)
        {
            foreach (var item in orphanedDatabases)
            {
                item.IsSelected = false;
            }
            StateHasChanged();
        }
    }

    private async Task DeleteSingle(OrphanedDatabaseInfo item)
    {
        isDeleting = true;
        StateHasChanged();

        try
        {
            await db.deleteDatabase(item.DatabaseName);
            orphanedDatabases?.Remove(item);
            toastService.Notify(new(ToastType.Success, $"Database {item.DatabaseName} deleted") { Title = "Success", AutoHide = true });
        }
        catch (Exception ex)
        {
            toastService.Notify(new(ToastType.Danger, $"Error deleting database: {ex.Message}") { Title = "Error", AutoHide = true });
        }

        isDeleting = false;
        StateHasChanged();
    }

    private async Task DeleteSelected()
    {
        if (orphanedDatabases == null) return;

        var selected = orphanedDatabases.Where(x => x.IsSelected).ToList();
        if (selected.Count == 0) return;

        isDeleting = true;
        StateHasChanged();

        int successCount = 0;
        int errorCount = 0;

        foreach (var item in selected)
        {
            try
            {
                await db.deleteDatabase(item.DatabaseName);
                orphanedDatabases.Remove(item);
                successCount++;
            }
            catch
            {
                errorCount++;
            }
        }

        isDeleting = false;

        if (successCount > 0)
        {
            toastService.Notify(new(ToastType.Success, $"Deleted {successCount} database(s)") { Title = "Success", AutoHide = true });
        }
        if (errorCount > 0)
        {
            toastService.Notify(new(ToastType.Warning, $"Failed to delete {errorCount} database(s)") { Title = "Warning", AutoHide = true });
        }

        StateHasChanged();
    }

    private string FormatSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        int order = 0;
        double size = bytes;
        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size /= 1024;
        }
        return $"{size:0.##} {sizes[order]}";
    }
}
