@layout EmptyLayout
@page "/"
@implements IDisposable

@using Microsoft.AspNetCore.Components
@using QRCoder
@using TelegramDownloader.Data
@using TelegramDownloader.Models
@using TelegramDownloader.Services
@inject ITelegramService ts
@inject ISetupService SetupService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime;
@inject PreloadService preloadService

<Preload LoadingText="Loading..." />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@23.0.12/build/css/intlTelInput.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<PageTitle>Login - Telegram File Manager</PageTitle>

<div class="login-page">
    <div class="login-card">
        @if (Model != null && Model.type != null)
        {
            <!-- Logo -->
            <div class="logo-container">
                <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram logo" />
            </div>

            <!-- Title based on step -->
            @switch (Model.type)
            {
                case "phone":
                    <h1 class="login-title">Welcome</h1>
                    <p class="login-subtitle">Enter your phone number to get started</p>
                    break;
                case "vc":
                    <h1 class="login-title">Verification</h1>
                    <p class="login-subtitle">Enter the code sent to your phone</p>
                    break;
                case "pass":
                    <h1 class="login-title">Two-Factor Auth</h1>
                    <p class="login-subtitle">Enter your 2FA password</p>
                    break;
                case "ok":
                    <h1 class="login-title">Welcome Back!</h1>
                    <p class="login-subtitle">You are successfully authenticated</p>
                    break;
            }

            <!-- Step indicator -->
            <div class="step-indicator">
                <div class="step @(Model.type == "phone" ? "active" : "completed")"></div>
                <div class="step @(Model.type == "vc" ? "active" : (Model.type == "pass" || Model.type == "ok" ? "completed" : ""))"></div>
                <div class="step @(Model.type == "pass" ? "active" : (Model.type == "ok" ? "completed" : ""))"></div>
                <div class="step @(Model.type == "ok" ? "active completed" : "")"></div>
            </div>

            <EditForm class="login-form" Model="Model" OnSubmit="Submit" FormName="LoginModel">
                @switch (Model.type)
                {
                    case "phone":
                        <div class="form-group">
                            <label for="phone"><i class="bi bi-telephone"></i> Phone Number</label>
                            <InputText class="form-control" id="phone" type="text" @bind-Value="Model!.value"
                                       aria-describedby="phone" maxlength="15" placeholder="+34 600 000 000" />
                        </div>
                        break;
                    case "vc":
                        <div class="form-group">
                            <label for="code"><i class="bi bi-shield-lock"></i> Verification Code</label>
                            <InputText class="form-control" id="code" maxlength="5" type="text"
                                       @bind-Value="Model!.value" placeholder="12345" autocomplete="one-time-code" />
                        </div>
                        break;
                    case "pass":
                        <div class="form-group">
                            <label for="pass"><i class="bi bi-key"></i> Password</label>
                            <InputText class="form-control" id="pass" type="password"
                                       @bind-Value="Model!.value" placeholder="Enter your 2FA password" />
                        </div>
                        break;
                    case "ok":
                        <div class="text-center">
                            <div class="success-badge">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>Authenticated</span>
                            </div>
                        </div>
                        break;
                }

                <div class="button-group">
                    @if (Model.type == "ok")
                    {
                        <button class="btn-danger-custom" @onclick="Salir" type="button">
                            <i class="bi bi-box-arrow-right"></i> Disconnect
                        </button>
                    }
                    else
                    {
                        <button class="btn-primary-custom" type="submit">
                            @if (Model.type == "phone")
                            {
                                <span>Continue</span>
                                <i class="bi bi-arrow-right"></i>
                            }
                            else
                            {
                                <span>Verify</span>
                                <i class="bi bi-check-lg"></i>
                            }
                        </button>
                        @if (Model.type != null && Model.type != "phone")
                        {
                            <button class="btn-secondary-custom" type="button" @onclick="Cancel">
                                Cancel
                            </button>
                        }
                    }
                </div>

                @if (!string.IsNullOrEmpty(imageString))
                {
                    <div class="qr-container">
                        <img src="data:image;base64, @imageString" alt="QR Code" />
                    </div>
                }
            </EditForm>

            <div class="login-footer">
                Telegram File Manager
            </div>
        }
        else
        {
            <!-- Loading/Checking state -->
            <div class="loading-container">
                <div class="loading-spinner">
                    <img class="loading-logo" src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram" />
                </div>
                <p class="loading-text">
                    Checking session
                    <span class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </span>
                </p>
                <p class="loading-subtext">Please wait while we verify your credentials</p>
            </div>
        }
    </div>
</div>

@code {
#nullable disable
    public LoginModel? Model { get; set; } = null;
    private CancellationToken cTokenQr { get; set; }
    CancellationTokenSource source { get; set; }
    private string imageString { get; set; }
    private string lastFocusedType = null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check if setup is complete using async method
            var status = await SetupService.GetSetupStatusAsync();
            if (status.CurrentStep != SetupStep.Complete)
            {
                NavManager.NavigateTo("/setup", forceLoad: true);
                return;
            }

            // If Telegram client is not configured, try to initialize it
            if (!ts.IsConfigured)
            {
                try
                {
                    ts.InitializeClient();
                }
                catch (Exception ex)
                {
                    // If initialization fails, redirect to setup
                    Console.WriteLine($"Failed to initialize Telegram client: {ex.Message}");
                    NavManager.NavigateTo("/setup", forceLoad: true);
                    return;
                }
            }

            Model ??= new();
            Model.type = await ts.checkAuth(Model.value);

            // Handle setup_required response - only redirect if actually not configured
            if (Model.type == "setup_required" && !ts.IsConfigured)
            {
                NavManager.NavigateTo("/setup", forceLoad: true);
                return;
            }

            StateHasChanged();
            await isLogin();
        }
        catch (NavigationException)
        {
            // Expected when navigating during initialization in Blazor Server
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Model?.type != null && Model.type != "ok" && Model.type != lastFocusedType)
        {
            lastFocusedType = Model.type;

            if (Model.type == "phone")
            {
                await JSRuntime.InvokeVoidAsync("loadCountries");
                await Task.Delay(100); // Small delay to ensure intl-tel-input is initialized
            }

            await FocusCurrentInput();
        }
    }

    private async Task FocusCurrentInput()
    {
        try
        {
            string elementId = Model?.type switch
            {
                "phone" => "phone",
                "vc" => "code",
                "pass" => "pass",
                _ => null
            };

            if (elementId != null)
            {
                await JSRuntime.InvokeVoidAsync("focusElement", elementId);
            }
        }
        catch
        {
            // Element might not be rendered yet
        }
    }

    private async void Submit()
    {
        if (Model.type == "phone")
        {
            var phone = await JSRuntime.InvokeAsync<string>("getNumber");
            Model.type = await ts.checkAuth(phone, Model.type == "phone") ?? "phone";
        }
        else
        {
            Model.type = await ts.checkAuth(Model.value, Model.type == "phone");
        }

        Model.value = "";
        StateHasChanged();
        await isLogin();
    }

    private async Task isLogin()
    {
        if (Model.type == "ok")
        {
            if (source != null)
            {
                if (source.Token.CanBeCanceled)
                {
                    source.Cancel();
                }
            }
            NavManager.NavigateTo("/fetchdata");
        }
    }

    private void GenerateQR(string data)
    {
        using (QRCodeGenerator qrGenerator = new QRCodeGenerator())
        using (QRCodeData qrCodeData = qrGenerator.CreateQrCode(data, QRCodeGenerator.ECCLevel.Q))
        using (PngByteQRCode qrCode = new PngByteQRCode(qrCodeData))
        {
            byte[] qrCodeImage = qrCode.GetGraphic(20);
            imageString = Convert.ToBase64String(qrCodeImage);
            StateHasChanged();
        }
    }

    private async void Salir()
    {
        await ts.logOff();
        Model.value = "";
        Model.type = "phone";
        StateHasChanged();
    }

    private async void Cancel()
    {
        await ts.logOff();
        NavManager.NavigateTo("/", true);
    }

    public void Dispose()
    {
        if (source != null)
        {
            if (source.Token.CanBeCanceled)
            {
                source.Cancel();
            }
        }
    }
}
