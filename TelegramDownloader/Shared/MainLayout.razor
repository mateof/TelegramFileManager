@inherits LayoutComponentBase
@implements IDisposable
@using TelegramDownloader.Data
@using TelegramDownloader.Models
@using TelegramDownloader.Models.GitHub
@using TelegramDownloader.Services
@using TelegramDownloader.Services.GitHub
@using TelegramDownloader.Shared
@inject ITelegramService ts
@inject NavigationManager NavManager
@inject IJSRuntime JS
@inject ModalService ModalService
@inject GHService ghService;
@inject TransactionInfoService tis;

<PageTitle>TelegramFileManager</PageTitle>

<style>
    .modalshow {
        display: block;
    }

    .modalhide {
        display: none;
    }

    /* Sidebar toggle button */
    .sidebar-toggle {
        padding: 0.25rem 0.5rem;
        font-size: 1.25rem;
        color: #333;
        text-decoration: none;
        border: none;
        background: transparent;
    }

    .sidebar-toggle:hover {
        color: #007bff;
    }

    /* Sidebar collapsed state - desktop only */
    @@media (min-width: 2048px) {
        .sidebar {
            transition: width 0.3s ease, min-width 0.3s ease;
        }

        .sidebar.collapsed {
            width: 0 !important;
            min-width: 0 !important;
            overflow: hidden !important;
            padding: 0 !important;
        }
    }

    /* Mobile: hide toggle button since NavMenu has its own */
    @@media (max-width: 2048px) {
        .sidebar-toggle {
            display: none;
        }

        /* Sidebar full height when nav menu is expanded */
        .sidebar {
            height: 100vh !important;
            min-height: 100vh !important;
        }

        /* Sidebar collapses when nav menu is collapsed */
        .sidebar.nav-collapsed {
            height: auto !important;
            min-height: auto !important;
            max-height: fit-content !important;
            overflow: hidden !important;
        }
    }
</style>

<link href="css/custombuttons.css" rel="stylesheet" />


<Preload LoadingText="Loading..." />


<div class="page @(sidebarCollapsed ? "sidebar-collapsed" : "")">
    <div class="sidebar @(sidebarCollapsed ? "collapsed" : "") @(navMenuCollapsed ? "nav-collapsed" : "")">
        <NavMenu @ref="menu" OnClickCallback="openOffCanvasMenu" OnClickOpenImportCallback="openImportModalMenu" OnCollapseChanged="OnNavMenuCollapseChanged" />
    </div>

    <main>
        <div class="top-row px-4 d-flex justify-content-end">
            <button class="btn btn-link sidebar-toggle me-auto" @onclick="ToggleSidebar">
                <i class="bi @(sidebarCollapsed ? "bi-list" : "bi-x-lg")"></i>
            </button>
            @if(active) {
                @if (tis.isUploading())
                {
                    <button class="btn water-fill-button upload @(GetUploadProgress() > 50 ? "filled-high" : "")"
                            @onclick='() => Navigateto("/downloads")'>
                        <span class="water-fill" style="height: @(GetUploadProgress())%;"></span>
                        <span class="water-wave" style="height: @(GetUploadProgress())%;"></span>
                        <span class="btn-content">
                            <Icon Class="arrow" Name="IconName.ArrowUp"></Icon>
                            <span>@tis.uploadSpeed</span>
                        </span>
                    </button>
                }
                @if(tis.isDownloading()) {
                    <button class="btn water-fill-button download @(GetDownloadProgress() > 50 ? "filled-high" : "")"
                            @onclick='() => Navigateto("/downloads")'>
                        <span class="water-fill" style="height: @(GetDownloadProgress())%;"></span>
                        <span class="water-wave" style="height: @(GetDownloadProgress())%;"></span>
                        <span class="btn-content">
                            <Icon Class="arrow" Name="IconName.ArrowDown"></Icon>
                            <span>@tis.downloadSpeed</span>
                        </span>
                    </button>
                }
                <Button Color="ButtonColor.None" Size="ButtonSize.Small" @onclick='() => Navigateto("/downloads")'>
                    <Spinner Type="SpinnerType.Border" />
                </Button>
            }
            <Button Color="ButtonColor.None" Size="ButtonSize.Small" @onclick="() => ShowModalVersion(ModalType.Info)">
                <Icon Name="IconName.InfoCircleFill" Size="IconSize.x2" Color="IconColor.Info" />
            </Button>
            <button class="btn" type="button" @onclick="openOffCanvasMenu"><i class="bi bi-three-dots"></i></button>
        </div>
        <TelegramDownloader.Pages.Modals.ToastNotify></TelegramDownloader.Pages.Modals.ToastNotify>

        <article class="content px-4">
            <div id="modalFileUploadVue">
                <TelegramDownloader.Pages.Modals.FileUploadModalTemplate></TelegramDownloader.Pages.Modals.FileUploadModalTemplate>
                <TelegramDownloader.Pages.Modals.AudioPlayerModal></TelegramDownloader.Pages.Modals.AudioPlayerModal>
            </div>
            @Body
        </article>

        <Offcanvas @ref="offcanvas"
        title="Menu">
            <BodyTemplate>
                <div class="list-group list-group-flush">
                    <button @onclick=' () => Navigateto("/config")' class="list-group-item list-group-item-action"><i class="bi bi-gear"></i> Configuration</button>
                    <button @onclick=' () => Navigateto("/webdavinfo")' class="list-group-item list-group-item-action">
                        <i class="bi bi-files-alt"></i> WebDav
                        <span class="position-absolute top-50 start-50 translate-middle badge rounded-pill bg-danger">
                            Beta
                            <span class="visually-hidden">Beta function</span>
                        </span>
                    </button>
                    <button @onclick=' () => Navigateto("/downloads")' class="list-group-item list-group-item-action"><i class="bi bi-cloud-download"></i> Tasks</button>
                    <button @onclick=' () => Navigateto("/loglist")' class="list-group-item list-group-item-action"><i class="bi bi-file-earmark-text"></i> Logs</button>
                    <a href="#" @onclick=" () => Logout()" class="list-group-item list-group-item-action list-group-item-warning"><i class="bi bi-box-arrow-right"></i> LogOut</a>
                </div>
            </BodyTemplate>
        </Offcanvas>
        <TelegramDownloader.Pages.Modals.ImportDataModal isShared=true @ref="ImportModal" OnCloseCallback="reloadMenu"></TelegramDownloader.Pages.Modals.ImportDataModal>

        <Modal IsServiceModal="true" />
        <Toasts class="p-3" AutoHide="true" Delay="4000" Placement="ToastsPlacement.TopRight" />
    </main>
</div>


@code {

    private Offcanvas offcanvas = default!;
    private Pages.Modals.ImportDataModal ImportModal { get; set; }
    private GithubVersionModel LastVersion { get; set; }
    private NavMenu menu { get; set; }
    private bool active { get; set; } = true;
    private bool sidebarCollapsed { get; set; } = false;
    private bool navMenuCollapsed { get; set; } = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                if (!ts.checkUserLogin()) NavManager.NavigateTo("/", true);
                LastVersion = await ghService.GetLastVersion();
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        checkWorkingTasks();
        tis.TaskEventChanged += eventChangedWorkingTasks;
    }

    private async Task reloadMenu()
    {
        menu.RefreshChannels();
    }


    private async Task ShowModalVersion(ModalType modalType)
    {
        var modalOption = new ModalOption
            {
                Title = "Versión",
                Message = GetType().Assembly.GetName().Version.ToString() == "0.0.0.0" ? "You have a docker version" : $@"Your versión is v{GetType().Assembly.GetName().Version.ToString()}
[[Last version is {(LastVersion != null ? LastVersion.tag_name : "")}]]",
                Type = modalType,
            };

        await ModalService.ShowAsync(modalOption);
    }

    private async Task openOffCanvasMenu()
    {
        await offcanvas.ShowAsync(); 
    }

    private async Task openImportModalMenu()
    {
        await ImportModal.Open();
    }

    private async Task openImportMenu()
    {
        await offcanvas.ShowAsync();
    }


    private void Notificar()
    {
        NotificationModel nm = new NotificationModel();
        nm.sendEvent(new Notification("<h1>Body message</h1>", "Title", NotificationTypes.Info));
    }

    private async Task Navigateto(string relativeUri)
    {
        await offcanvas.HideAsync();
        NavManager.NavigateTo(relativeUri);
    }


    private async void Logout()
    {
        await ts.logOff();
        NavManager.NavigateTo("/");
        StateHasChanged();
    }

    private async Task checkWorkingTasks() {
        active = tis.isWorking();
        await InvokeAsync(StateHasChanged);
    }

    private int GetDownloadProgress()
    {
        var activeDownload = tis.downloadModels.FirstOrDefault(x => x.state == StateTask.Working);
        return activeDownload?.progress ?? 0;
    }

    private int GetUploadProgress()
    {
        var activeUpload = tis.uploadModels.FirstOrDefault(x => x.state == StateTask.Working);
        return activeUpload?.progress ?? 0;
    }

    private void eventChangedWorkingTasks(object sender, System.EventArgs e)
    {
        checkWorkingTasks();
    }

    private void ToggleSidebar()
    {
        sidebarCollapsed = !sidebarCollapsed;
    }

    private void OnNavMenuCollapseChanged(bool isCollapsed)
    {
        navMenuCollapsed = isCollapsed;
        StateHasChanged();
    }

    public void Dispose()
    {
        tis.TaskEventChanged -= eventChangedWorkingTasks;
    }
}
